name: Deploy Docs (Native)

on:
  push:
    branches: [main]
    paths:
      - 'etfdata/**'
      - '.github/workflows/deploy-docs.yml'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: etfdata
    steps:
      - uses: actions/checkout@v4

      - name: Build WASM packages
        uses: r-wasm/actions/build-rwasm@v2
        with:
          packages: |
            ./etfdata
            shiny
            dplyr
            ggplot2
            DT
            htmltools
            httr2
            janitor
            readr
            stringr
            purrr
            lubridate
            tzdb
            vroom
            bit
            bit64
            clipr
            crayon
            munsell
            scales
            gtable
            isoband
            farver
            labeling
            RColorBrewer
            viridisLite
            S7
            tidyr
            tibble
            quantmod
            TTR
            xts
            zoo
          repo-path: wasm-repo
          image-path: wasm-image
          strip: "demo, doc, examples, help, html, include, tests, vignette"

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-bin
          path: wasm-repo

  deploy:
    needs: build-wasm
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install Shinylive Quarto Extension
        run: |
          quarto install extension shinylive --no-prompt
          # Shinylive uses 'quarto-shinylive' or 'shinylive' as extension name.
          # The above should install 'shinylive'.


      - name: Install dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::pkgdown
            any::quarto
            any::targets
            any::tarchetypes
            any::devtools
            any::visNetwork
          working-directory: 'etfdata'

      - name: Build Site
        run: |
          Rscript -e 'devtools::install("etfdata")'
          Rscript -e 'setwd("etfdata"); targets::tar_make()'
          Rscript -e 'pkgdown::build_site("etfdata")'
          mkdir -p _site
          cp -r etfdata/docs/* _site/

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-bin
          path: wasm-repo

      - name: Stage WASM repo
        run: |
          mkdir -p _site/bin
          cp -r wasm-repo/* _site/bin/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
