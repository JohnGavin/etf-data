---
title: "ETF Data Analysis"
format: 
  html:
    code-fold: true
    code-summary: "Show Code"
vignette: >
  %\VignetteIndexEntry{ETF Data Analysis}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false
library(etfdata)
library(ggplot2)
library(dplyr)

# Debug helper
debug_msg <- function(...) message(paste(..., collapse = " "))

tryCatch({
  # Strategy: Load snapshot from installed package (CI) or source (Local)
  snapshot_file <- "vignette_data.rds"
  data_path <- system.file("extdata", snapshot_file, package = "etfdata")
  
  debug_msg("Initial system.file path:", data_path)

  if (data_path == "" || !file.exists(data_path)) {
    # Try relative source path (Local dev)
    data_path <- file.path("..", "inst", "extdata", snapshot_file)
    debug_msg("Fallback to relative path:", data_path)
  }

  if (file.exists(data_path)) {
    debug_msg("Found snapshot at:", data_path)
    debug_msg("File size:", file.size(data_path))
    
    snap <- readRDS(data_path)
    universe <- snap$universe
    metadata <- snap$metadata
    history <- snap$history
    
    debug_msg("Loaded data. Universe rows:", nrow(universe))
  } else {
    debug_msg("Snapshot NOT found. Falling back to targets store.")
    library(targets)
    tar_config_set(store = "../_targets")
    universe <- tar_read(universe)
    metadata <- tar_read(metadata)
    history <- tar_read(history)
  }
}, error = function(e) {
  debug_msg("CRITICAL ERROR in setup:", e$message)
  # Create dummy data to prevent rendering crash
  universe <- tibble(ticker = "ERROR", name = "Error loading data")
  metadata <- tibble(ticker = "ERROR", isin = "X", aum_text = "N/A", ter_text = "N/A", replication = "N/A")
  history <- tibble(date = Sys.Date(), close = 0, ticker = "ERROR", volume = 0)
})
```

## ETF Universe

We start by defining the universe of European UCITS ETFs.

```{r universe-code}
#| echo: true
#| eval: false
# Code used to generate this data:
get_etf_universe()
```

```{r universe-table}
#| echo: false
kable(universe)
```

## Metadata (JustETF)

We scraped JustETF for metadata including AUM and TER.

```{r metadata-code}
#| echo: true
#| eval: false
# Code used:
fetch_etf_metadata(universe$isin)
```

```{r metadata-table}
#| echo: false
kable(metadata %>% select(isin, aum_text, ter_text, replication))
```

## Price History (Yahoo Finance)

We fetched daily price history.

```{r history-plot}
#| echo: true
#| message: false

# Visualize Close Prices
history %>%
  ggplot(aes(x = date, y = close, color = ticker)) +
  geom_line() +
  labs(title = "ETF Price History (LSE)", y = "Close Price (GBP)") +
  theme_minimal()
```

## Combined Analysis

Relationship between AUM and Liquidity (Volume)?

```{r combined}
#| echo: true
# Join data
avg_vol <- history %>%
  group_by(ticker) %>%
  summarise(avg_daily_vol = mean(volume, na.rm = TRUE))

combined <- universe %>%
  inner_join(metadata, by = "isin") %>%
  inner_join(avg_vol, by = "ticker")

kable(combined %>% select(ticker, name, aum_text, avg_daily_vol))
```