---
title: "ETF Data Analysis"
format: 
  html:
    code-fold: true
    code-summary: "Show Code"
vignette: >
  %\VignetteIndexEntry{ETF Data Analysis}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false
library(etfdata)
library(targets)
library(ggplot2)
library(dplyr)

# 1. Try Environment Variable (CI)
store_path <- Sys.getenv("TARGETS_STORE")

# 2. Try Local File (Sidecar for CI if Env Var fails)
if (store_path == "" && file.exists("targets_store_path.txt")) {
  store_path <- trimws(readLines("targets_store_path.txt", warn = FALSE)[1])
  message("Read store path from file: ", store_path)
}

# 3. Default to relative path (Local interactive)
if (store_path == "") {
  store_path <- "../_targets"
  message("Defaulting to relative path: ", store_path)
}

message("Final Store Path: ", store_path)

if (dir.exists(store_path)) {
  message("Store path verified: ", store_path)
} else {
  message("WARNING: Store path not found: ", store_path)
  # Attempt to list parent dirs to help debug
  message("CWD: ", getwd())
  message("Parent dir contents: ", paste(list.files(".."), collapse = ", "))
}

# Set the store
tar_config_set(store = store_path)
```

## ETF Universe

We start by defining the universe of European UCITS ETFs.

```{r universe-code}
#| echo: true
#| eval: false
# Code used to generate this data:
get_etf_universe()
```

```{r universe-table}
#| echo: false
universe <- tar_read(universe)
kable(universe)
```

## Metadata (JustETF)

We scraped JustETF for metadata including AUM and TER.

```{r metadata-code}
#| echo: true
#| eval: false
# Code used:
fetch_etf_metadata(universe$isin)
```

```{r metadata-table}
#| echo: false
metadata <- tar_read(metadata)
kable(metadata %>% select(isin, aum_text, ter_text, replication))
```

## Price History (Yahoo Finance)

We fetched daily price history.

```{r history-plot}
#| echo: true
#| message: false
history <- tar_read(history)

# Visualize Close Prices
history %>%
  ggplot(aes(x = date, y = close, color = ticker)) +
  geom_line() +
  labs(title = "ETF Price History (LSE)", y = "Close Price (GBP)") +
  theme_minimal()
```

## Combined Analysis

Relationship between AUM and Liquidity (Volume)?

```{r combined}
#| echo: true
# Join data
avg_vol <- history %>%
  group_by(ticker) %>%
  summarise(avg_daily_vol = mean(volume, na.rm = TRUE))

combined <- universe %>%
  inner_join(metadata, by = "isin") %>%
  inner_join(avg_vol, by = "ticker")

kable(combined %>% select(ticker, name, aum_text, avg_daily_vol))
```