---
title: "etfdata in WebAssembly (WASM)"
format: html
filters:
  - webr
engine: knitr
webr:
  packages:
    - dplyr
    - ggplot2
    - tidyr
    - stringr
    - tibble
    - httr2
    - janitor
    - readr
    - scales
    - zoo
    - xts
    - TTR
    - quantmod
    - etfdata
  repos:
    - https://johngavin.github.io/etf-data/bin/
vignette: >
  %\VignetteIndexEntry{etfdata in WebAssembly (WASM)}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

This vignette demonstrates the `etfdata` package running entirely in your browser using [WebR](https://docs.r-wasm.org/webr/latest/).

```{webr-r}
#| context: setup
#| echo: false
# Supress startup messages and print summary
suppressPackageStartupMessages({
  library(etfdata)
  library(ggplot2)
})

# Print package summary
pkgs <- installed.packages()[, "Package"]
sorted_pkgs <- sort(pkgs)
n_pkgs <- length(sorted_pkgs)
cat(sprintf("WebR Session Initialized.\nLoaded %d packages.\n", n_pkgs))
if (n_pkgs > 6) {
  cat("First 3: ", paste(head(sorted_pkgs, 3), collapse=", "), "\n")
  cat("Last 3:  ", paste(tail(sorted_pkgs, 3), collapse=", "), "\n")
} else {
  cat("Packages: ", paste(sorted_pkgs, collapse=", "), "\n")
}
```

## Data Analysis Example

We retrieve the ETF universe included in the package and fetch price history.

*Note: Fetching data from Yahoo Finance (via `fetch_price_history`) might be blocked by CORS policies in the browser. If it fails, we default to the universe data.*

```{webr-r}
#| caption: "Real Data Analysis"
# 1. Get Universe (from package data)
universe <- etfdata::get_etf_universe(n = 5)
print("ETF Universe (Top 5):")
print(universe)

# 2. Try to Fetch History (Yahoo)
# Wrapping in tryCatch due to potential CORS issues in WASM
history <- tryCatch({
  # Attempt to fetch for the first ticker
  ticker <- universe$ticker[1]
  print(paste("Attempting to fetch history for:", ticker))
  etfdata::fetch_price_history(ticker, start_date = "2023-01-01")
}, error = function(e) {
  message("Could not fetch price history (likely CORS blocked): ", e$message)
  return(NULL)
})

if (!is.null(history)) {
  print(head(history))
  
  # Plot
  ggplot(history, aes(x = date, y = close)) +
    geom_line(color = "darkblue") +
    labs(title = paste("Price History:", universe$ticker[1]), y = "Close Price") +
    theme_minimal()
} else {
  # Fallback plot using universe data (e.g. dummy AUM/Currency)
  ggplot(universe, aes(x = currency)) +
    geom_bar(fill = "steelblue") +
    labs(title = "Universe Composition by Currency", y = "Count") +
    theme_minimal()
}
```

## JustETF Screener

Query the JustETF API directly.

```{webr-r}
#| caption: "JustETF Screener"
get_cached_screener <- function(min_aum_gbp = 200, max_ter = 0.75) {
  path <- system.file("extdata", "vignette_data.rds", package = "etfdata")
  if (path == "" || !file.exists(path)) {
    return(dplyr::tibble())
  }

  snap <- readRDS(path)
  if (!all(c("metadata", "universe") %in% names(snap))) {
    return(dplyr::tibble())
  }

  snap$metadata |>
    dplyr::mutate(
      aum_num = readr::parse_number(.data$aum_text),
      ter_num = readr::parse_number(.data$ter_text)
    ) |>
    dplyr::left_join(snap$universe, by = "isin") |>
    dplyr::filter(
      .data$aum_num >= min_aum_gbp,
      .data$ter_num <= max_ter
    )
}

is_webr <- grepl("emscripten", R.version$os, ignore.case = TRUE)
screener <- if (is_webr) {
  message("Using cached screener snapshot (browser CORS blocks JustETF API).")
  get_cached_screener(min_aum_gbp = 200)
} else {
  tryCatch(
    etfdata::fetch_justetf_screener(min_aum_gbp = 200),
    error = function(e) {
      message("Screener failed: ", e$message)
      get_cached_screener(min_aum_gbp = 200)
    }
  )
}

if (nrow(screener) > 0) {
  print(head(screener))
} else {
  print("No results returned from screener.")
}
```
