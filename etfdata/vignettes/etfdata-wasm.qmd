---
title: "etfdata in WebAssembly (WASM)"
format: html
filters:
  - webr
engine: knitr
webr:
  packages:
    - dplyr
    - ggplot2
    - tidyr
    - stringr
    - tibble
    - httr2
    - janitor
    - readr
  repos:
    - https://repo.r-wasm.org/
    - https://johngavin.github.io/etf-data/
vignette: >
  %\VignetteIndexEntry{etfdata in WebAssembly (WASM)}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

This vignette demonstrates the `etfdata` package running entirely in your browser using [WebR](https://docs.r-wasm.org/webr/latest/).

## Interactive R Console

You can run R code directly below. Press "Run Code" to execute.

```{webr-r}
#| caption: "Check WebR Environment"
version$version.string
```

## Installing etfdata

Dependencies are preloaded. We now install `etfdata` from the package's own WASM repository (hosted on GitHub Pages).

```{webr-r}
#| caption: "Install etfdata"
# Install 'etfdata' from our GitHub Pages WASM repo
tryCatch({
  install.packages("etfdata")
}, warning = function(w) {
  message("Warning during installation: ", w$message)
}, error = function(e) {
  message("etfdata could not be installed in WASM: ", e$message)
})
```

## Data Analysis Example

If `etfdata` is not available, we simulate the data structure to demonstrate the analysis workflow in WebR.

```{webr-r}
#| caption: "Interactive Plotting"
library(dplyr)
library(ggplot2)

# Simulated universe if package missing
universe <- tibble(
  ticker = c("VUSA.L", "CSPX.L", "INRG.L"),
  name = c("Vanguard S&P 500", "iShares Core S&P 500", "iShares Clean Energy"),
  currency = "GBP"
)

print(universe)

# Create a dummy plot
df <- data.frame(
  x = rnorm(100),
  y = rnorm(100)
)

ggplot(df, aes(x, y)) +
  geom_point(color = "blue") +
  theme_minimal() +
  labs(title = "Interactive Plot in WebR")
```

## JustETF Screener

If the package is installed and internet access is permitted, you can query the JustETF API.

```{webr-r}
#| caption: "JustETF Screener (Requires Package)"
if (requireNamespace("etfdata", quietly = TRUE)) {
  library(etfdata)
  # Fetch ETFs with > 200m GBP AUM
  try({
    screener <- fetch_justetf_screener(min_aum_gbp = 200)
    print(head(screener))
  })
} else {
  print("etfdata package not available in this WASM session.")
}
```